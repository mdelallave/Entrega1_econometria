%% Limpiamos
close('all')
clearvars
clc

%% Importar datos
% data = xlsread('ibex.csv','B3:C1558');
% ibex = data; 
% En el mac no me va la función de importar datos con xlsread. Probad si
% funciona.

%% Hacemos un gráfico con Ibex
figure(1);
plot(ibex);
title('Ibex');
subplot(2,1,1);
autocorr(ibex,20);
title('ACF del IBEX');
subplot(2,1,2);
parcorr(ibex,20); 
title('PACF del  IBEX');

%% Analisis de estacionariedad.
% Aplicamos un gráfico media-varianza
part=100;
[med,dtip] = graf_m_std(ibex,part);
% Los datos en nivel no presentan estacionariedad

%% Manipulación de los datos
% Transformación logarítmica (rendimientos)
libex = 100*log(ibex);

% Estudiamos su estacionariedad
figure(2);
subplot(2,1,1);
autocorr(libex,20);
title('ACF del log del IBEX');
subplot(2,1,2);
parcorr(libex,20); 
title('PACF del log del IBEX');

% Vemos como la ACF toma valores muy altos que no tienden a desaparecer.
% Indica ausencia de estacionariedad.

%% Tomamos primeras diferencias y analizamos estacionariedad.
dlibex=libex(2:end)-libex(1:end-1);
figure(3);
plot(dlibex);
title('Rendimiento del Ibex');
figure(4);
subplot(2,1,1);
autocorr(dlibex,20); 
title('ACF del Rendimiento del Ibex');
subplot(2,1,2);
parcorr(dlibex,20);
title('PACF del Rendimiento del Ibex');

% LA ACF ya no presenta infinitos valores significativos. La serie presenta
% estacionariedad. Sin embargo, dlibex presenta un valor muy grande en la
% observación 958 que mas tarde trataremos de controlar mediante una variable dummy.

%% Modelo
modelo=arima(1,1,1);
estmodelo=estimate(modelo,libex); 
% Estimamos un modelo ARIMA(1,1,1) sobre el modelo en logaritmos.
% La constante no es significativa.

%% Hacemos inferencia
[res,varres,logL] = infer(estmodelo,libex); %inferencia sobre el modelo.
resstd = res/sqrt(estmodelo.Variance);
[h,p,jbstat,critval] = jbtest(resstd, 0.01) 
%test jarque bera. h=1 rechazo normalidad.
figure;
subplot(2,2,1);
plot(resstd); 
title('Residuos estandarizados modelo 1');
subplot(2,2,2);
histogram(resstd,10);
title('Residuos Estandarizados modelo 1')
subplot(2,2,3);
autocorr(resstd,16);
subplot(2,2,4);
parcorr(resstd,16);
%% Modelo 2
modelo2=arima('Constant',0,'ARLags',[2,4,5,11],'MALags',[4,9,11],'D',1);
estmodelo2=estimate(modelo2,libex); 

%% Hacemos inferencia
[res2,varres2,logL2] = infer(estmodelo2,libex); %inferencia sobre el modelo.
resstd2 = res2/sqrt(estmodelo2.Variance);
[h2,p2,jbstat2,critval2]=jbtest(resstd2,0.01) 
%test jarque bera. h=1 -> rechazo normalidad.
figure;
subplot(2,2,1);
plot(resstd2); 
title('Residuos estandarizados modelo 2');
subplot(2,2,2);
histogram(resstd2,10);
title('Residuos Estandarizados modelo 2')
subplot(2,2,3);
autocorr(resstd2,16);
subplot(2,2,4);
parcorr(resstd2,16);
%% Función impulso
dummyImp = zeros(1569,1);
dummyImp(958) = 1;
%% Modelo 3
modelo3=arima('Constant',0,'ARLags',[2,4,5],'MALags',[4,9],'D',1);
estmodelo3 = estimate(modelo3,libex,'X', dummyImp); 
% estimamos el modelo. Introduciendo la dummy como variable explicativa, el
% AR(11) y el MA(11) no son significativos.

%% Hacemos inferencia
[res2,varres2,logL2] = infer(estmodelo3,libex); %inferencia sobre el modelo.
resstd2 = res2/sqrt(estmodelo2.Variance);
[h2,p2,jbstat2,critval2]=jbtest(resstd2,0.01) 
%test jarque bera. h=1 -> rechazo normalidad.
figure;
subplot(2,2,1);
plot(resstd2); 
title('Residuos estandarizados modelo 3');
subplot(2,2,2);
histogram(resstd2,10);
title('Residuos Estandarizados modelo 3')
subplot(2,2,3);
autocorr(resstd2,16);
subplot(2,2,4);
parcorr(resstd2,16);
%% Hacemos una predicción

% Aquí he hecho una predicción del valor del rendimiento del ibex hasta
% final del año 2018 (70 días). Por lo que entiendo, el enunciado no pide esto; 
% sino una predicción mediante simulación, a partir de la distribución de los
% epsilón a fecha T (último dato disponible). Por tanto, entiendo que hay
% que hacer, por ejemplo, 10.000 simulaciones de 70 valores de una normal.
% Luego, calcular el valor de los rendimientos del Ibex hasta T+70 con las
% 10.000 simulaciones. Y con estos datos en T+70, obtener la probabilidad de 
% que el rendimiento obtenido sea menor que el valor de los rendimientos a 
% fecha T. (clase 25/09; 1:03:00)

% Dudas: 1) los residuos no se comportan como una
% normal, por tanto, bajo que distribución simulo los valores de epsilón
% desde T hasta T+70. 2) No veo cómo plantear el bucle para obtener los
% valores de los rendimientos en T+70 para 10.000 simulaciones.

[libex_f,dt_errorf] = forecast(estmodelo2,70,'Y0', libex);
b_inferior = libex_f - 1.96*sqrt(dt_errorf);
b_superior = libex_f + 1.96*sqrt(dt_errorf);
figure;
plot(libex,'Color',[.7,.7,.7]);
hold on
h1 = plot(1556:1625,b_inferior,'r:','LineWidth',2);
plot(1556:1625,b_superior,'r:','LineWidth',2)
h2 = plot(1556:1625,libex_f,'k','LineWidth',2); %predicción
legend([h1 h2],'Intervalo al 95% de confianza','Predicción puntual',...
	     'Location','NorthWest')
title('Predicción del Ibex a cierre de año')
hold off
%% Calculamos la probabilidad



